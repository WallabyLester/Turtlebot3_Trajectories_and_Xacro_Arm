#!/usr/bin/env python
"""
Subscribes to a turtlesim/Pose message
Publishes the corresponding nav_msgs/Odometry message
The header frame is odom
The child frame is base_footprint
You can leave covariance information as zeros
Broadcasts the corresponding transform between odom and base_link
"""

import rospy
from turtlesim.msg import Pose
from nav_msgs.msg import Odometry
import tf2_ros
from tf_conversions import transformations
from geometry_msgs.msg import TransformStamped, Twist, Vector3

class Simodom():
    def __init__(self):
        rospy.Subscriber("turtle1/pose", Pose, self.broadcast_odom)
        self.pub = rospy.Publisher('/odom', Odometry, queue_size=10)
        self.rate = rospy.Rate(10)
        self.theta = 0
        self.x = 0
        self.y = 0
        self.linear_vel = 0
        self.angular_vel = 0

    def broadcast_odom(self, data):
        self.x = data.x
        self.y = data.y
        self.theta = data.theta
        self.linear_vel = data.linear_velocity
        self.angular_vel = data.angular_velocity
        self.broadcaster = tf2_ros.TransformBroadcaster()

        odom = TransformStamped()
        odom.header.stamp = rospy.Time.now()
        odom.header.frame_id = "odom"
        odom.child_frame_id = "base_footprint"

        q1 = transformations.quaternion_from_euler(0, 0 , self.theta)

        odom.transform.translation.x = 0
        odom.transform.translation.y = 0
        odom.transform.translation.z = 0

        odom.transform.rotation.x = q1[0]
        odom.transform.rotation.y = q1[1]
        odom.transform.rotation.z = q1[2]
        odom.transform.rotation.w = q1[3]

        self.broadcaster.sendTransform(odom)

    def publish_odom(self):
        # publish odometry 
        msg = Odometry()

        msg.header.stamp = rospy.Time.now()
        msg.header.frame_id = "odom"
        msg.child_frame_id = "base_footprint"

        q2 = transformations.quaternion_from_euler(0, 0, self.theta)

        msg.pose.pose.position.x = self.x
        msg.pose.pose.position.y = self.y
        msg.pose.pose.position.z = 0

        msg.pose.pose.orientation.x = q2[0]
        msg.pose.pose.orientation.y = q2[1]
        msg.pose.pose.orientation.z = q2[2]
        msg.pose.pose.orientation.w = q2[3]

        msg.twist.twist = Twist(Vector3(self.linear_vel, self.angular_vel,0), 
                                Vector3(0, 0, self.theta))
        
        self.pub.publish(msg)
        #self.rate.sleep()


    def run(self):
        while not rospy.is_shutdown():
            self.publish_odom()

if __name__ == '__main__':
    rospy.init_node("simodom", log_level=rospy.DEBUG)
    sim = Simodom()
    sim.run()
    rospy.spin()
